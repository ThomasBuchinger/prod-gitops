---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
  namespace: opencloud
data:
  # enable services that are not started automatically
  # OC_ADD_RUN_SERVICES: ${START_ADDITIONAL_SERVICES}
  OC_URL: https://docs.cloud.buc.sh
  # OC_LOG_LEVEL: ${LOG_LEVEL:-info}
  # OC_LOG_COLOR: "${LOG_PRETTY:-false}"
  # OC_LOG_PRETTY: "${LOG_PRETTY:-false}"
  # do not use SSL between the reverse proxy and OpenCloud
  # PROXY_TLS: "false"
  # INSECURE: needed if OpenCloud / reverse proxy is using self generated certificates
  OC_INSECURE: "true"
  # basic auth (not recommended, but needed for eg. WebDav clients that do not support OpenID Connect)
  # PROXY_ENABLE_BASIC_AUTH: "${PROXY_ENABLE_BASIC_AUTH:-false}"
  # demo users
  # IDM_CREATE_DEMO_USERS: "${DEMO_USERS:-false}"
  # admin password
  IDM_ADMIN_PASSWORD: "changeme"
  # email server (if configured)
  # NOTIFICATIONS_SMTP_HOST: "${SMTP_HOST}"
  # NOTIFICATIONS_SMTP_PORT: "${SMTP_PORT}"
  # NOTIFICATIONS_SMTP_SENDER: "${SMTP_SENDER:-OpenCloud Notifications <notifications@cloud.opencloud.test>}"
  # NOTIFICATIONS_SMTP_USERNAME: "${SMTP_USERNAME}"
  # NOTIFICATIONS_SMTP_PASSWORD: "${SMTP_PASSWORD}"
  # NOTIFICATIONS_SMTP_INSECURE: "${SMTP_INSECURE:-false}"
  # NOTIFICATIONS_SMTP_AUTHENTICATION: "${SMTP_AUTHENTICATION}"
  # NOTIFICATIONS_SMTP_ENCRYPTION: "${SMTP_TRANSPORT_ENCRYPTION:-none}"
  # FRONTEND_ARCHIVER_MAX_SIZE: "10000000000"
  # FRONTEND_CHECK_FOR_UPDATES: "${CHECK_FOR_UPDATES:-true}"
  # PROXY_CSP_CONFIG_FILE_LOCATION: /etc/opencloud/csp.yaml
  # enable to allow using the banned passwords list
  # OC_PASSWORD_POLICY_BANNED_PASSWORDS_LIST: banned-password-list.txt
  # control the password enforcement and policy for public shares
  # OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD: "${OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD:-true}"
  # OC_SHARING_PUBLIC_WRITEABLE_SHARE_MUST_HAVE_PASSWORD: "${OC_SHARING_PUBLIC_WRITEABLE_SHARE_MUST_HAVE_PASSWORD:-false}"
  # OC_PASSWORD_POLICY_DISABLED: "${OC_PASSWORD_POLICY_DISABLED:-false}"
  # OC_PASSWORD_POLICY_MIN_CHARACTERS: "${OC_PASSWORD_POLICY_MIN_CHARACTERS:-8}"
  # OC_PASSWORD_POLICY_MIN_LOWERCASE_CHARACTERS: "${OC_PASSWORD_POLICY_MIN_LOWERCASE_CHARACTERS:-1}"
  # OC_PASSWORD_POLICY_MIN_UPPERCASE_CHARACTERS: "${OC_PASSWORD_POLICY_MIN_UPPERCASE_CHARACTERS:-1}"
  # OC_PASSWORD_POLICY_MIN_DIGITS: "${OC_PASSWORD_POLICY_MIN_DIGITS:-1}"
  # OC_PASSWORD_POLICY_MIN_SPECIAL_CHARACTERS: "${OC_PASSWORD_POLICY_MIN_SPECIAL_CHARACTERS:-1}"
  # default language for services/WebUI; defaults to English, language code (ISO 639-1, e.g. de, en, fr)
  OC_DEFAULT_LANGUAGE: de # en

  opencloud.yaml: |-
    token_manager:
      jwt_secret: 3-XhRlx3.nRx0oYxSl57U1om85@2LWBQ
    machine_auth_api_key: l%aC4=um.tNAxv3q0=f@y^tjELX#NjO.
    system_user_api_key: R^1Vv^^jINgJt^GN46z%SnCaOYnsCBmM
    transfer_secret: WqB782qRX@OsZPPzUAjZTKQJSctY1AS@
    url_signing_secret: ykZHuZNxnvBrs1#g^3dplhG#yahnz=oA
    system_user_id: d2ce9b10-1aac-4521-8e21-630ed0cdb391
    admin_user_id: 437c73e7-4c73-4618-9898-ecb759046221
    graph:
      application:
        id: bf5da4e7-857d-4e4d-afee-a086f2c75b57
      events:
        tls_insecure: true
      spaces:
        insecure: true
      identity:
        ldap:
          bind_password: 3e*!hwm8wHpyL8MN=^siZmab6=0Azad3
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    idp:
      ldap:
        bind_password: 35s4q.xyQ@=a!CkC1zrNo!XPerBh#VNI
    idm:
      service_user_passwords:
        admin_password: admin
        idm_password: 3e*!hwm8wHpyL8MN=^siZmab6=0Azad3
        reva_password: E8pVpz=XSx7gkFzJNg5QxsPL7^9!JRnl
        idp_password: 35s4q.xyQ@=a!CkC1zrNo!XPerBh#VNI
    collaboration:
      wopi:
        secret: TB4pOtvH.#QeE-09!1t+6tgRFPzyWxJd
      app:
        insecure: true
    proxy:
      oidc:
        insecure: true
      insecure_backends: true
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    frontend:
      app_handler:
        insecure: true
      archiver:
        insecure: true
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
      ocdav:
        insecure: true
    auth_basic:
      auth_providers:
        ldap:
          bind_password: E8pVpz=XSx7gkFzJNg5QxsPL7^9!JRnl
    auth_bearer:
      auth_providers:
        oidc:
          insecure: true
    users:
      drivers:
        ldap:
          bind_password: E8pVpz=XSx7gkFzJNg5QxsPL7^9!JRnl
    groups:
      drivers:
        ldap:
          bind_password: E8pVpz=XSx7gkFzJNg5QxsPL7^9!JRnl
    ocm:
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    thumbnails:
      thumbnail:
        transfer_secret: '&OY=l#WY1Cz3crER%Fvd$M-hfk6@=bpF'
        webdav_allow_insecure: true
        cs3_allow_insecure: true
    search:
      events:
        tls_insecure: true
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    audit:
      events:
        tls_insecure: true
    settings:
      service_account_ids:
      - d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
    sharing:
      events:
        tls_insecure: true
    storage_users:
      events:
        tls_insecure: true
      mount_id: 48c27a38-aeea-4620-9bf7-ccbd3b617e60
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    notifications:
      notifications:
        events:
          tls_insecure: true
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    nats:
      nats:
        tls_skip_verify_client_cert: true
    gateway:
      storage_registry:
        storage_users_mount_id: 48c27a38-aeea-4620-9bf7-ccbd3b617e60
    userlog:
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    auth_service:
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    clientlog:
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1
    activitylog:
      service_account:
        service_account_id: d281cc8b-445d-4b4a-8be0-c6a1fa5e59f7
        service_account_secret: 4%vwkDvR@hPP8WebKb2imrhXmMiILxU1

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opencloud
  namespace: opencloud
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: opencloud
  template:
    metadata:
      labels:
        app.kubernetes.io/name: opencloud
    spec:
      containers:
      - name: opencloud
        image: opencloudeu/opencloud-rolling:latest
        envFrom:
        - configMapRef:
            name: config
        securityContext:
          capabilities:
            drop:
            - ALL
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          privileged: false
          readOnlyRootFilesystem: true
        volumeMounts:
        - name: opencloud-data
          mountPath: /var/lib/opencloud
        - name: opencloud-config
          mountPath: /etc/opencloud
          subPath: opencloud.yaml
      volumes:
      - name: opencloud-data
        emptyDir: {}
        # persistentVolumeClaim:
        #   claimName: opencloud-pvc
      - name: opencloud-config
        configMap:
          name: config

---
apiVersion: v1
kind: Service
metadata:
  name: opencloud
  namespace: opencloud
spec:
  selector:
    app: opencloud
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: opencloud-ingress
  namespace: opencloud
spec:
  tls:
  - hosts:
    - docs.buc.sh
    secretName: cert-docs-buc-sh
  rules:
    - host: docs.buc.sh
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: opencloud
                port:
                  number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: opencloud-http
  namespace: opencloud
spec:
  rules:
    - host: docs.10.0.0.21.nip.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: opencloud
                port:
                  number: 80
# ---
# apiVersion: v1
# kind: PersistentVolumeClaim
# metadata:
#   name: opencloud-pvc
#   namespace: opencloud
# spec:
#   accessModes:
#     - ReadWriteOnce
#   resources:
#     requests:
#       storage: 10Gi

